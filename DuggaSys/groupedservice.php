<?php
date_default_timezone_set("Europe/Stockholm");

// Include basic application services!
include_once "../Shared/sessions.php";
include_once "../Shared/basic.php";

// Connect to database and start session
pdoConnect();
session_start();

if(isset($_SESSION['uid'])){
	$userid=$_SESSION['uid'];
	$loginname=$_SESSION['loginname'];
	$lastname=$_SESSION['lastname'];
	$firstname=$_SESSION['firstname'];
}else{
	$userid=1;
	$loginname="UNK";		
	$lastname="UNK";
	$firstname="UNK";
} 	

// Options from AJAX 
$opt = getOP('opt');
$cid = getOP('cid'); // Course id
$vers = getOP('vers'); // Course version
$listentry = getOP('moment');
$qvariant=getOP("qvariant");

$data = []; // Array that contains all data generated by the queries in this file. To be written to JSON. 

$debug="NONE!"; // How is this used? Is it neccessary?

// Don't retreive all results if request was for a single dugga or a grade update
//if(strcmp($opt,"GET")==0){
 	//if(checklogin() && (hasAccess($_SESSION['uid'], $cid, 'w') || isSuperUser($_SESSION['uid']))) {

		// First query: get the headings for the table, which is the listentry names. 
		$query = $pdo->prepare("SELECT listentries.*,quizFile,COUNT(variant.vid) as qvariant FROM listentries LEFT JOIN quiz ON  listentries.link=quiz.id LEFT JOIN variant ON quiz.id=variant.quizID WHERE listentries.cid=:cid and listentries.vers=:vers and (listentries.kind=4) AND (listentries.grouptype=1 OR listentries.grouptype=3) GROUP BY lid ORDER BY pos;");

		// Constant parameters for testing.
		$cid = 2;
		$vers = 97732;

		$query->bindParam(':cid', $cid);
		$query->bindParam(':vers', $vers);

		if(!$query->execute()) {
			$error=$query->errorInfo();
			$debug="Error retreiving moments and duggas. (row ".__LINE__.") ".$query->rowCount()." row(s) were found. Error code: ".$error[2];
		}

		$currentMoment=null; // This is a mystery

		$headings = []; // Create a array that holds the headings. 

		// Save the headings for the table 
		foreach($query->fetchAll(PDO::FETCH_ASSOC) as $row){
			array_push(
				$headings,
				array(
					'entryname' => $row['entryname'],
					'lid' => (int)$row['lid'],
					'kind' => (int)$row['kind'],
					'moment' => (int)$row['moment'],
					'visible'=> (int)$row['visible']
				)
			);
		}

		// Put it in the data array
		$data['headings'] = $headings;

		// Second query: Select all users that are connected to the course and the current version of it. Order by the uid. 
		$query = $pdo->prepare("SELECT user.uid, user.username FROM user, user_course WHERE user.uid = user_course.uid AND user_course.cid = :cid AND user_course.vers = :vers ORDER BY user.uid");

		$query->bindParam(':cid', $cid);
		$query->bindParam(':vers', $vers);
		
		if(!$query->execute()) {
			$error=$query->errorInfo();
			$debug="Error retreiving moments and duggas. (row ".__LINE__.") ".$query->rowCount()." row(s) were found. Error code: ".$error[2];
		}

		// Get the first two columns, which is the students and their groups. Save this information, and set the group assignments after the next query. 
		$studentUidAndUsernames = $query->fetchAll(PDO::FETCH_ASSOC); // 2 rows initially. (count = 2)

		// Third query: Select all user id's that are connected to a group and their lid. 
		$query = $pdo->prepare("SELECT uug.uid, ugl.lid, uug.ugid FROM user_usergroup AS uug, usergroup_listentries AS ugl, listentries AS l WHERE uug.ugid = ugl.ugid AND ugl.lid = l.lid AND l.cid = :cid AND l.vers = :vers AND l.kind = 4 AND (l.grouptype=1 OR l.grouptype=3) ORDER BY uug.uid");

		$query->bindParam(':cid', $cid);
		$query->bindParam(':vers', $vers);

		if(!$query->execute()) {
			$error=$query->errorInfo();
			$debug="Error retreiving moments and duggas. (row ".__LINE__.") ".$query->rowCount()." row(s) were found. Error code: ".$error[2];
		}

		// Assigned courses
		$assignedGroups = $query->fetchAll(PDO::FETCH_ASSOC);

		// Create array to hold the table contents. 
		$tableContent = [];

		foreach($studentUidAndUsernames as $studentRow) { 
			// Iterera en rad, student. 
			$lidstogroups = [];
			foreach($assignedGroups as $groupRow) {
				// Om det Ã¤r samma student som gruppraden
				// Fyll i gruppinformation per lid. 
				if($studentRow['uid'] == $groupRow['uid']) {
					$lidstogroups[$groupRow['lid']] = $groupRow['ugid'];
				}
			}
			$studentRow['lidstogroups'] = $lidstogroups;
		}

		echo '<pre>';
		print_r($studentAndGroupRows);
		echo '</pre>';
		
		/*$uniqueLids = array_unique($uniqueLids); // 

		$keyTemplate = array_fill_keys($uniqueLids, 0);

		$rowNumber = 1;
		// For each group entry row, create the columns, linking each group to the associated listentry. 
		foreach($studentAndGroupRows as $dbRow) { // Loop through the number of rows. 

			// Create array for the row. 
			$row = [];
			
			// array_push($row, $dbRow['ugid']);
			$row['ugid'] = $dbRow['ugid'];
			// array_push($row, $cid);
			$row['cid'] = $cid;	
			// array_push($row, $dbRow['students']);
			$row['username'] = $dbRow['username'];
			$row['uid'] = $dbRow['uid'];
			// array_push($row, $dbRow['groupname']);
			$row['name'] = $dbRow['name'];

			// Iterate through the listentries, and add the list entry id where there is a match for the group. This should later be presented as some kind of boolean instead, to be able to use buttons. 
			$assignedLids = $keyTemplate;
			foreach ($assignedCourses as $dbCol) { // Iterate the assigned courses (what lids match which ugid). 
				foreach($assignedLids as $key => $val) {
					if($row['ugid'] == $dbCol['ugid']) {
						$assignedLids[$dbCol['lid']] = 1;
					}
				}
			}
			$row['assignedlids'] = $assignedLids;
			array_push($tableContent, $row);

			$rowNumber++;
		} */
		$data['tableContent'] = $tableContent;
 	//}
//}

if(isset($_SERVER["REQUEST_TIME_FLOAT"])){
		$serviceTime = microtime(true) - $_SERVER["REQUEST_TIME_FLOAT"];	
		$benchmark =  array('totalServiceTime' => $serviceTime);
}else{
		$benchmark="-1";
}

// This is possibly needed later, for debugging and benchmarking and such.
$array = array(
	/* 
	'data' => $data,
	'debug' => $debug,
	'moment' => $listentry,
	'benchmark' => $benchmark */
);

// Print only the $data contents array as JSON for now. 
echo json_encode($data);
// logServiceEvent($log_uuid, EventTypes::ServiceServerEnd, "resultedservice.php",$userid,$info);
?>
